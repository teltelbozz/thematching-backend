<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TheMatching Demo</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
    }
    h1 { margin-bottom: 12px; }

    /* ===== Tabs ===== */
    .tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      margin-bottom: 12px;
    }
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
    }
    .tab.active {
      border-color: #0070f3;
      color: #0070f3;
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ===== Common UI ===== */
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    input, select, button {
      padding: 8px 10px;
      font-size: 14px;
    }
    button { cursor: pointer; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 10px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #fafafa;
      position: sticky;
      top: 0;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-block;
    }
    .pill.female { background: #ffe8f1; }
    .pill.male { background: #e8f2ff; }

    .muted { color: #777; font-size: 12px; }
    .status.ok { color: #067d17; }
    .status.err { color: #b00020; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

    hr { border: 0; border-top: 1px solid #eee; margin: 16px 0; }
  </style>
</head>

<body>
<h1>TheMatching Demo</h1>

<!-- ===== Admin Token ===== -->
<div class="row">
  <label>Admin Token:</label>
  <input id="token" type="password" size="32" placeholder="thematching-cron-2025-01" />
  <span class="muted">※ /admin /cron 系API共通</span>
</div>

<hr />

<!-- ===== Tabs ===== -->
<div class="tabs">
  <div class="tab active" data-tab="users">Users</div>
  <div class="tab" data-tab="results">Matching Results</div>
</div>

<!-- ===================================================== -->
<!-- ====================== USERS ======================== -->
<!-- ===================================================== -->
<div id="tab-users" class="tab-panel active">

  <div class="row">
    <label>Gender:</label>
    <select id="gender">
      <option value="">all</option>
      <option value="female">female</option>
      <option value="male">male</option>
    </select>

    <label>Search:</label>
    <input id="q" placeholder="nickname / LINE_xxx / user_id" />

    <button id="loadUsers">Load Users</button>
    <span id="usersStatus" class="status"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>User ID</th>
        <th>Nickname</th>
        <th>Gender</th>
        <th>Age</th>
        <th>LINE</th>
        <th>Verified</th>
        <th>Created</th>
      </tr>
    </thead>
    <tbody id="usersTbody"></tbody>
  </table>
</div>

<!-- ===================================================== -->
<!-- ================= MATCHING RESULTS ================== -->
<!-- ===================================================== -->
<div id="tab-results" class="tab-panel">

  <div class="row">
    <label>slotDt:</label>
    <input id="slotDt" size="32"
      value="2025-12-05T19:00:00+09:00" />

    <button id="runMatching">▶ Run Matching</button>
    <button id="loadResults">Load Results</button>

    <span id="resultsStatus" class="status"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Group</th>
        <th>Slot</th>
        <th>Location</th>
        <th>Type</th>
        <th>Status</th>
        <th>Token</th>
        <th>Female</th>
        <th>Male</th>
      </tr>
    </thead>
    <tbody id="resultsTbody"></tbody>
  </table>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  /* ===== Tabs ===== */
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
      tab.classList.add("active");
      $("tab-" + tab.dataset.tab).classList.add("active");
    });
  });

  function tokenOrAlert() {
    const t = $("token").value.trim();
    if (!t) { alert("Admin Token を入力してください"); return null; }
    return t;
  }

  function esc(s) {
    return String(s).replace(/[&<>"']/g, c =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])
    );
  }

  /* ===== Load Users ===== */
  $("loadUsers").onclick = async () => {
    const token = tokenOrAlert(); if (!token) return;

    const url = new URL("/admin/users", location.origin);
    if ($("gender").value) url.searchParams.set("gender", $("gender").value);
    if ($("q").value) url.searchParams.set("q", $("q").value);
    url.searchParams.set("limit", "300");

    $("usersStatus").textContent = "loading...";
    $("usersTbody").innerHTML = "";

    const res = await fetch(url, { headers:{Authorization:`Bearer ${token}`}});
    if (!res.ok) {
      $("usersStatus").textContent = "error";
      alert(await res.text());
      return;
    }
    const data = await res.json();
    $("usersStatus").textContent = `loaded ${data.count}`;

    $("usersTbody").innerHTML = data.users.map(u => `
      <tr>
        <td>${u.user_id}</td>
        <td>${esc(u.nickname || "(none)")}</td>
        <td><span class="pill ${u.gender}">${u.gender}</span></td>
        <td>${u.age || "—"}</td>
        <td class="muted">${esc(u.line_user_id || "")}</td>
        <td>${u.verified_age ? "✅" : "—"}</td>
        <td class="muted">${new Date(u.created_at).toLocaleString("ja-JP")}</td>
      </tr>
    `).join("");
  };

  /* ===== Run Matching ===== */
  $("runMatching").onclick = async () => {
    const token = tokenOrAlert(); if (!token) return;
    const slotDt = $("slotDt").value.trim();
    if (!slotDt) return alert("slotDt を入力してください");

    $("resultsStatus").textContent = "running...";

    const res = await fetch("/cron/matching/manual", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`
      },
      body: JSON.stringify({ slotDt })
    });

    if (!res.ok) {
      $("resultsStatus").textContent = "error";
      alert(await res.text());
      return;
    }

    $("resultsStatus").textContent = "done";
    $("loadResults").click();
  };

  /* ===== Load Results ===== */
  $("loadResults").onclick = async () => {
    const token = tokenOrAlert(); if (!token) return;
    const slotDt = $("slotDt").value.trim();

    const url = new URL("/admin/matching-results", location.origin);
    url.searchParams.set("slotDt", slotDt);

    $("resultsStatus").textContent = "loading...";
    $("resultsTbody").innerHTML = "";

    const res = await fetch(url, { headers:{Authorization:`Bearer ${token}`}});
    if (!res.ok) {
      $("resultsStatus").textContent = "error";
      alert(await res.text());
      return;
    }

    const data = await res.json();
    $("resultsStatus").textContent = `loaded ${data.count}`;

    const render = p => `
      <div>
        <span class="pill ${p.gender}">${p.gender}</span>
        <b>${esc(p.nickname)}</b>
        <span class="muted">(${p.age})</span>
      </div>
    `;

    $("resultsTbody").innerHTML = data.groups.map(g => `
      <tr>
        <td class="mono">${g.groupId}</td>
        <td>${new Date(g.slotDt).toLocaleString("ja-JP")}</td>
        <td>${g.location}</td>
        <td>${g.typeMode}</td>
        <td>${g.status}</td>
        <td class="mono">${g.token}</td>
        <td>${g.female.map(render).join("")}</td>
        <td>${g.male.map(render).join("")}</td>
      </tr>
    `).join("");
  };
</script>
</body>
</html>