<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TheMatching Demo</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
    }
    h1 { margin-bottom: 12px; }

    /* ===== Tabs ===== */
    .tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      margin-bottom: 12px;
    }
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      user-select: none;
    }
    .tab.active {
      border-color: #0070f3;
      color: #0070f3;
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ===== Common UI ===== */
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    input, select, button, textarea {
      padding: 8px 10px;
      font-size: 14px;
    }
    button { cursor: pointer; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 10px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-block;
      line-height: 1.4;
    }
    .pill.female { background: #ffe8f1; }
    .pill.male { background: #e8f2ff; }
    .pill.active { background: #e8fff0; }
    .pill.processed { background: #f2f2f2; }

    .muted { color: #777; font-size: 12px; }
    .status.ok { color: #067d17; }
    .status.err { color: #b00020; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

    hr { border: 0; border-top: 1px solid #eee; margin: 16px 0; }

    /* ===== Users row hover/click ===== */
    tr.user-row { cursor: pointer; }
    tr.user-row:hover { background: #fafafa; }

    /* ===== Drawer ===== */
    #drawerBackdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      z-index: 20;
    }
    #drawer {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: min(520px, 92vw);
      background: #fff;
      border-left: 1px solid #eee;
      box-shadow: -8px 0 24px rgba(0,0,0,.10);
      padding: 16px;
      overflow: auto;
      z-index: 30;
    }
    .drawer-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }
    .drawer-title { font-weight: 700; }
    .drawer-sub { margin-top: 2px; }
    .kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 6px 10px;
      margin-top: 12px;
    }
    .kv .k { color:#666; font-size:12px; }
    .kv .v { font-size: 14px; }
    .drawer-section-title {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 14px;
      font-weight: 700;
    }
    .mini-table th, .mini-table td { padding: 8px; }

    .btn-ghost {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .btn-primary {
      background: #0070f3;
      border: 1px solid #0070f3;
      color: #fff;
      border-radius: 8px;
    }
    .btn-danger {
      background: #fff;
      border: 1px solid #f0b0b0;
      color: #b00020;
      border-radius: 8px;
    }

    /* ===== Results extra sections ===== */
    .section-title {
      margin-top: 14px;
      font-weight: 700;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .card {
      margin-top: 10px;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      cursor: pointer;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .mini {
      font-size: 12px;
      color: #555;
    }

    /* ===== Ops Message Modal ===== */
    #opsBackdrop {
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.25);
      z-index: 60;
    }
    #opsModal {
      display:none;
      position:fixed;
      inset: 0;
      margin:auto;
      width: min(760px, 92vw);
      height: min(86vh, 860px);
      background:#fff;
      border: 1px solid #eee;
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.18);
      padding: 14px;
      overflow:auto;
      z-index: 70;
    }
    .ops-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .ops-title { font-weight: 800; }
    .ops-sub { margin-top: 2px; }
    .ops-grid {
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 10px 12px;
      margin-top: 10px;
    }
    .ops-grid .k { font-size: 12px; color:#555; padding-top: 8px; }
    .ops-grid input, .ops-grid textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 10px;
      outline: none;
    }
    .ops-grid textarea {
      min-height: 110px;
      resize: vertical;
      line-height: 1.5;
    }
    .ops-actions {
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      margin-top: 12px;
      border-top: 1px solid #eee;
      padding-top: 12px;
    }
    .ops-help {
      font-size: 12px;
      color: #666;
      line-height: 1.45;
    }
    .link {
      color: #0070f3;
      text-decoration: none;
    }
    .link:hover { text-decoration: underline; }
  </style>
</head>

<body>
<h1>TheMatching Demo</h1>

<!-- ===== Admin Token ===== -->
<div class="row">
  <label>Admin Token:</label>
  <input id="token" type="password" size="32" placeholder="thematching-cron-2025-01" />
  <span class="muted">※ /admin /cron 系API共通</span>
</div>

<hr />

<!-- ===== Tabs ===== -->
<div class="tabs">
  <div class="tab active" data-tab="users">Users</div>
  <div class="tab" data-tab="results">Matching Results</div>
</div>

<!-- ===================================================== -->
<!-- ====================== USERS ======================== -->
<!-- ===================================================== -->
<div id="tab-users" class="tab-panel active">

  <div class="row">
    <label>Gender:</label>
    <select id="gender">
      <option value="">all</option>
      <option value="female">female</option>
      <option value="male">male</option>
    </select>

    <label>Search:</label>
    <input id="q" placeholder="nickname / LINE_xxx / user_id" />

    <button class="btn-primary" id="loadUsers">Load Users</button>
    <span id="usersStatus" class="status muted"></span>

    <span class="muted">（行クリックで詳細＆スロット表示）</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>User ID</th>
        <th>Nickname</th>
        <th>Gender</th>
        <th>Age</th>
        <th>LINE</th>
        <th>KYC</th>
        <th>Created</th>
      </tr>
    </thead>
    <tbody id="usersTbody"></tbody>
  </table>
</div>

<!-- ===================================================== -->
<!-- ================= MATCHING RESULTS ================== -->
<!-- ===================================================== -->
<div id="tab-results" class="tab-panel">

  <div class="row">
    <label>slotDt:</label>
    <input id="slotDt" size="32" value="2025-12-05T19:00:00+09:00" />

    <button class="btn-primary" id="runMatching">▶ Run Matching</button>
    <button class="btn-ghost" id="loadResults">Load Results</button>

    <span id="resultsStatus" class="status muted"></span>
  </div>

  <!-- Matched groups table -->
  <div class="section-title">
    <span>Matched Groups</span>
    <span class="muted" id="groupsMeta"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Group</th>
        <th>Slot</th>
        <th>Location</th>
        <th>Type</th>
        <th>Status</th>
        <th>Token</th>
        <th>Ops Msg</th>
        <th>Female</th>
        <th>Male</th>
      </tr>
    </thead>
    <tbody id="resultsTbody"></tbody>
  </table>

  <!-- Unmatched users -->
  <div class="section-title">
    <span>Unmatched Users</span>
    <span class="muted" id="unmatchedMeta"></span>
  </div>

  <div id="unmatchedWrap" class="grid"></div>
</div>

<!-- ===== Drawer UI (User detail) ===== -->
<div id="drawerBackdrop"></div>

<aside id="drawer">
  <div class="drawer-header">
    <div>
      <div class="drawer-title" id="drawerTitle">User Detail</div>
      <div class="drawer-sub muted" id="drawerSub"></div>
    </div>
    <div class="row" style="gap:8px; margin:0;">
      <button class="btn-ghost" id="drawerReload">Reload</button>
      <button class="btn-danger" id="drawerClose">Close</button>
    </div>
  </div>

  <div id="drawerBody" class="muted">select a user…</div>
</aside>

<!-- ===== Ops Message Modal ===== -->
<div id="opsBackdrop"></div>
<div id="opsModal" role="dialog" aria-modal="true" aria-label="運営メッセージ編集">
  <div class="ops-header">
    <div>
      <div class="ops-title">運営メッセージ編集</div>
      <div class="ops-sub muted" id="opsSub">—</div>
      <div class="muted" style="margin-top:6px;">
        公開ページ:
        <a id="opsPublicLink" class="link" href="#" target="_blank" rel="noreferrer">open</a>
        <span class="muted">（/g/:token）</span>
      </div>
    </div>
    <div class="row" style="margin:0; gap:8px;">
      <button class="btn-ghost" id="opsReload">Reload</button>
      <button class="btn-danger" id="opsClose">Close</button>
    </div>
  </div>

  <div class="ops-grid">
    <div class="k">店名（venue_name）</div>
    <div><input id="opsVenueName" placeholder="例）渋谷ワイン食堂 XXX" /></div>

    <div class="k">住所（venue_address）</div>
    <div><input id="opsVenueAddress" placeholder="例）東京都渋谷区..." /></div>

    <div class="k">地図URL（venue_map_url）</div>
    <div><input id="opsVenueMapUrl" placeholder="Google Map URL など" /></div>

    <div class="k">料金（fee_text）</div>
    <div><textarea id="opsFeeText" placeholder="例）男性 6,000円 / 女性 3,000円（現金）"></textarea></div>

    <div class="k">注意事項/連絡（notes）</div>
    <div><textarea id="opsNotes" placeholder="例）開始10分前に集合 / 遅刻時はLINE連絡 など"></textarea></div>
  </div>

  <div class="ops-actions">
    <div>
      <span id="opsStatus" class="status muted"></span>
      <div class="ops-help">
        ※ 保存は Admin API（Bearer Token）でDBへ反映します。<br/>
        ※ 反映後、公開ページ（/g/:token）側で同内容が表示されます。
      </div>
    </div>
    <div class="row" style="margin:0; gap:8px;">
      <button class="btn-ghost" id="opsClear">Clear</button>
      <button class="btn-primary" id="opsSave">Save</button>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  // ===== API prefix (Vercel: Express is mounted under /api) =====
  const API_PREFIX = "/api";
  const api = (path) => API_PREFIX + path;

  /* ===== Tabs ===== */
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
      tab.classList.add("active");
      $("tab-" + tab.dataset.tab).classList.add("active");
    });
  });

  function tokenOrAlert() {
    const t = $("token").value.trim();
    if (!t) { alert("Admin Token を入力してください"); return null; }
    return t;
  }

  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, c =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])
    );
  }

  function setStatus(el, text, kind) {
    el.textContent = text;
    el.classList.remove("ok", "err");
    if (kind) el.classList.add(kind);
  }

  function fmtDateJa(iso) {
    if (!iso) return "—";
    try { return new Date(iso).toLocaleString("ja-JP"); }
    catch { return String(iso); }
  }

  /* ===== Drawer (User) ===== */
  let currentUserId = null;

  function openDrawer() {
    $("drawerBackdrop").style.display = "block";
    $("drawer").style.display = "block";
  }
  function closeDrawer() {
    $("drawerBackdrop").style.display = "none";
    $("drawer").style.display = "none";
  }

  $("drawerClose").addEventListener("click", closeDrawer);
  $("drawerBackdrop").addEventListener("click", closeDrawer);

  $("drawerReload").addEventListener("click", () => {
    if (currentUserId != null) loadUserDetail(currentUserId);
  });

  // ✅ KYC toggle
  async function toggleKyc(userId, next) {
    const token = tokenOrAlert(); if (!token) return;

    const ok = confirm(next
      ? "このユーザーをKYC承認しますか？"
      : "KYC承認を解除しますか？"
    );
    if (!ok) return;

    let res;
    try {
      res = await fetch(api(`/admin/users/${userId}/kyc`), {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ verified: !!next }),
      });
    } catch (e) {
      alert(e?.message || String(e));
      return;
    }

    if (!res.ok) {
      alert(await res.text());
      return;
    }

    // 再読込
    loadUserDetail(userId);
  }

  async function loadUserDetail(userId) {
    const token = tokenOrAlert(); if (!token) return;

    currentUserId = userId;
    openDrawer();
    $("drawerTitle").textContent = `User #${userId}`;
    $("drawerSub").textContent = "";
    $("drawerBody").innerHTML = "loading...";

    const detailUrl = new URL(api(`/admin/users/${userId}`), location.origin);
    const slotsUrl  = new URL(api(`/admin/users/${userId}/slots`), location.origin);
    slotsUrl.searchParams.set("limit", "200");

    let r1, r2;
    try {
      [r1, r2] = await Promise.all([
        fetch(detailUrl, { headers:{Authorization:`Bearer ${token}`} }),
        fetch(slotsUrl,  { headers:{Authorization:`Bearer ${token}`} }),
      ]);
    } catch (e) {
      $("drawerBody").innerHTML = `<div class="status err">network error</div><pre class="mono">${esc(e?.message || String(e))}</pre>`;
      return;
    }

    if (!r1.ok) {
      $("drawerBody").innerHTML = `<div class="status err">detail error: ${r1.status}</div><pre class="mono">${esc(await r1.text())}</pre>`;
      return;
    }
    if (!r2.ok) {
      $("drawerBody").innerHTML = `<div class="status err">slots error: ${r2.status}</div><pre class="mono">${esc(await r2.text())}</pre>`;
      return;
    }

    const d = await r1.json();
    const s = await r2.json();

    const u = d.user || {};
    const slots = (s.slots || []);

    $("drawerTitle").textContent = `${u.nickname ? u.nickname : "User"} #${u.user_id}`;
    $("drawerSub").textContent = u.line_user_id ? u.line_user_id : "";

    const genderClass = u.gender === "female" ? "female" : (u.gender === "male" ? "male" : "");
    const age = (u.age === 0 || u.age === "0" || u.age == null) ? "—" : u.age;

    const pillClass = (st) => (st === "processed" ? "processed" : (st === "active" ? "active" : ""));

    const slotRows = slots.map(x => `
      <tr>
        <td class="mono">${esc(x.slot_jst || "")}</td>
        <td class="muted">${esc(x.week_key || "")}</td>
        <td>${esc(x.type_mode || "")}</td>
        <td>${esc(x.location || "")}</td>
        <td><span class="pill ${pillClass(x.status)}">${esc(x.status || "")}</span></td>
      </tr>
    `).join("");

    // ✅ Photo (prefer masked)
    const photoUrl = u.photo_masked_url || u.photo_url || "";
    const photoHtml = photoUrl ? `
      <div style="display:flex; align-items:center; gap:12px; margin: 8px 0 10px;">
        <img
          src="${esc(photoUrl)}"
          alt="photo"
          style="width:72px; height:72px; border-radius:999px; object-fit:cover; background:#f2f2f2;"
          onerror="this.style.display='none';"
        />
        <div class="muted" style="font-size:12px;">photo</div>
      </div>
    ` : `
      <div class="muted" style="margin: 8px 0 10px; font-size:12px;">photo: —</div>
    `;

    // ✅ KYC
    const kycHtml = `
      <div style="margin: 6px 0 10px;">
        <b>KYC:</b>
        ${u.kyc_verified ? "✅ 承認済み" : "— 未確認"}
        ${u.kyc_verified_at ? `<div class="muted mini">${esc(fmtDateJa(u.kyc_verified_at))}</div>` : ""}
        <div class="row" style="margin-top:8px;">
          <button
            class="btn-primary"
            onclick="toggleKyc(${Number(u.user_id)}, ${u.kyc_verified ? "false" : "true"})">
            ${u.kyc_verified ? "KYCを解除" : "KYCを承認"}
          </button>
        </div>
      </div>
    `;

    $("drawerBody").innerHTML = `
      <div>
        ${photoHtml}
        ${kycHtml}

        <div class="row" style="margin: 0;">
          <span class="pill ${genderClass}">${esc(u.gender || "-")}</span>
          <span>Age: <b>${esc(age)}</b></span>
        </div>

        <div class="kv">
          <div class="k">user_id</div><div class="v mono">${esc(u.user_id)}</div>
          <div class="k">line_user_id</div><div class="v mono">${esc(u.line_user_id || "—")}</div>
          <div class="k">created_at</div><div class="v">${esc(fmtDateJa(u.created_at))}</div>
        </div>
      </div>

      <hr />

      <div class="drawer-section-title">
        <span>Registered Slots</span>
        <span class="muted">${slots.length}件</span>
      </div>

      <table class="mini-table" style="width:100%; border-collapse:collapse; margin-top:8px;">
        <thead>
          <tr>
            <th style="text-align:left; border-bottom:1px solid #eee;">slot (JST)</th>
            <th style="text-align:left; border-bottom:1px solid #eee;">week_key</th>
            <th style="text-align:left; border-bottom:1px solid #eee;">type</th>
            <th style="text-align:left; border-bottom:1px solid #eee;">location</th>
            <th style="text-align:left; border-bottom:1px solid #eee;">slot_status</th>
          </tr>
        </thead>
        <tbody>
          ${slotRows || `<tr><td colspan="5" class="muted">no slots</td></tr>`}
        </tbody>
      </table>
    `;
  }

  /* ===== Ops Message Modal ===== */
  let currentGroup = null; // { groupId, token, slotDt, location, typeMode, status }

  function openOpsModal() {
    $("opsBackdrop").style.display = "block";
    $("opsModal").style.display = "block";
  }
  function closeOpsModal() {
    $("opsBackdrop").style.display = "none";
    $("opsModal").style.display = "none";
  }

  $("opsClose").addEventListener("click", closeOpsModal);
  $("opsBackdrop").addEventListener("click", closeOpsModal);

  $("opsClear").addEventListener("click", () => {
    $("opsVenueName").value = "";
    $("opsVenueAddress").value = "";
    $("opsVenueMapUrl").value = "";
    $("opsFeeText").value = "";
    $("opsNotes").value = "";
    setStatus($("opsStatus"), "cleared", null);
  });

  $("opsReload").addEventListener("click", async () => {
    if (!currentGroup?.token) return;
    await loadOpsMessage(currentGroup.token);
  });

  $("opsSave").addEventListener("click", async () => {
    if (!currentGroup?.groupId) return alert("group is not selected");
    await saveOpsMessage(currentGroup.groupId);
  });

  function setOpsHeader() {
    const g = currentGroup;
    if (!g) {
      $("opsSub").textContent = "—";
      $("opsPublicLink").href = "#";
      return;
    }
    $("opsSub").textContent =
      `group_id=${g.groupId} / token=${g.token} / slot=${fmtDateJa(g.slotDt)} / ${g.location} / ${g.typeMode}`;

    // 公開ページリンク（フロント）
    const publicUrl = `https://thematching-frontend.vercel.app/g/${encodeURIComponent(g.token)}`;
    $("opsPublicLink").href = publicUrl;
  }

  async function loadOpsMessage(token) {
    setStatus($("opsStatus"), "loading...", null);

    let res;
    try {
      // 公開API（完全共有型）で group を取得（venue/fee/notesを含む想定）
      res = await fetch(api(`/groups/${encodeURIComponent(token)}`), { method: "GET" });
    } catch (e) {
      setStatus($("opsStatus"), "network error", "err");
      alert(e?.message || String(e));
      return;
    }

    if (!res.ok) {
      const t = await res.text().catch(() => "");
      setStatus($("opsStatus"), `load error ${res.status}`, "err");
      alert(t || `load error ${res.status}`);
      return;
    }

    const data = await res.json().catch(() => null);
    const grp = data?.group || {};

    $("opsVenueName").value = grp.venue_name ?? "";
    $("opsVenueAddress").value = grp.venue_address ?? "";
    $("opsVenueMapUrl").value = grp.venue_map_url ?? "";
    $("opsFeeText").value = grp.fee_text ?? "";
    $("opsNotes").value = grp.notes ?? "";

    setStatus($("opsStatus"), "loaded", "ok");
  }

  async function saveOpsMessage(groupId) {
    const token = tokenOrAlert(); if (!token) return;

    const payload = {
      venue_name: $("opsVenueName").value.trim() || null,
      venue_address: $("opsVenueAddress").value.trim() || null,
      venue_map_url: $("opsVenueMapUrl").value.trim() || null,
      fee_text: $("opsFeeText").value.trim() || null,
      notes: $("opsNotes").value.trim() || null,
    };

    setStatus($("opsStatus"), "saving...", null);

    let res;
    try {
      // ★要：backendで実装するAdmin API
      // 例: PATCH /admin/groups/:groupId/ops-message
      res = await fetch(api(`/admin/groups/${encodeURIComponent(groupId)}/ops-message`), {
        method: "PATCH",
        headers: {
          "Content-Type":"application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });
    } catch (e) {
      setStatus($("opsStatus"), "network error", "err");
      alert(e?.message || String(e));
      return;
    }

    if (!res.ok) {
      const t = await res.text().catch(() => "");
      setStatus($("opsStatus"), `save error ${res.status}`, "err");
      alert(
        (t || "").slice(0, 2000) ||
        `save error ${res.status}\n(backendに /admin/groups/:id/ops-message の実装が必要かもしれません)`
      );
      return;
    }

    setStatus($("opsStatus"), "saved", "ok");

    // 念のため再ロードして整合させる
    if (currentGroup?.token) {
      await loadOpsMessage(currentGroup.token);
    }
  }

  // results rowから呼ぶ
  async function openOpsEditorFromRow(groupId, token, slotDt, location, typeMode, status) {
    currentGroup = { groupId, token, slotDt, location, typeMode, status };
    setOpsHeader();
    openOpsModal();
    await loadOpsMessage(token);
  }
  window.openOpsEditorFromRow = openOpsEditorFromRow; // inline onclick用

  /* ===== Load Users ===== */
  $("loadUsers").onclick = async () => {
    const token = tokenOrAlert(); if (!token) return;

    const url = new URL(api("/admin/users"), location.origin);
    if ($("gender").value) url.searchParams.set("gender", $("gender").value);
    if ($("q").value) url.searchParams.set("q", $("q").value);
    url.searchParams.set("limit", "300");

    setStatus($("usersStatus"), "loading...", null);
    $("usersTbody").innerHTML = "";

    let res;
    try {
      res = await fetch(url, { headers:{Authorization:`Bearer ${token}`}});
    } catch (e) {
      setStatus($("usersStatus"), "network error", "err");
      alert(e?.message || String(e));
      return;
    }

    if (!res.ok) {
      setStatus($("usersStatus"), `error ${res.status}`, "err");
      alert(await res.text());
      return;
    }

    const data = await res.json();
    setStatus($("usersStatus"), `loaded ${data.count}`, "ok");

    $("usersTbody").innerHTML = (data.users || []).map(u => {
      const age = (u.age === 0 || u.age === "0") ? "—" : (u.age ?? "—");
      const kyc = (u.kyc_verified === true) ? "✅" : "—";
      return `
        <tr class="user-row" data-user-id="${esc(u.user_id)}" title="click to open detail">
          <td class="mono">${esc(u.user_id)}</td>
          <td>${esc(u.nickname || "(none)")}</td>
          <td><span class="pill ${esc(u.gender)}">${esc(u.gender || "")}</span></td>
          <td>${esc(age)}</td>
          <td class="muted mono">${esc(u.line_user_id || "")}</td>
          <td>${kyc}</td>
          <td class="muted">${esc(fmtDateJa(u.created_at))}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="7" class="muted">no users</td></tr>`;

    // 行クリック → ドロワー
    document.querySelectorAll("tr.user-row[data-user-id]").forEach(tr => {
      tr.addEventListener("click", () => {
        const id = tr.getAttribute("data-user-id");
        if (id) loadUserDetail(id);
      });
    });
  };

  /* ===== Run Matching ===== */
  $("runMatching").onclick = async () => {
    const token = tokenOrAlert(); if (!token) return;
    const slotDt = $("slotDt").value.trim();
    if (!slotDt) return alert("slotDt を入力してください");

    setStatus($("resultsStatus"), "running...", null);

    let res;
    try {
      res = await fetch(api("/cron/matching/manual"), {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body: JSON.stringify({ slotDt })
      });
    } catch (e) {
      setStatus($("resultsStatus"), "network error", "err");
      alert(e?.message || String(e));
      return;
    }

    if (!res.ok) {
      setStatus($("resultsStatus"), `error ${res.status}`, "err");
      alert(await res.text());
      return;
    }

    setStatus($("resultsStatus"), "done", "ok");
    $("loadResults").click();
  };

  /* ===== Load Results ===== */
  $("loadResults").onclick = async () => {
    const token = tokenOrAlert(); if (!token) return;
    const slotDt = $("slotDt").value.trim();
    if (!slotDt) return alert("slotDt を入力してください");

    const url = new URL(api("/admin/matching-results"), location.origin);
    url.searchParams.set("slotDt", slotDt);

    setStatus($("resultsStatus"), "loading...", null);
    $("resultsTbody").innerHTML = "";
    $("unmatchedWrap").innerHTML = "";
    $("groupsMeta").textContent = "";
    $("unmatchedMeta").textContent = "";

    let res;
    try {
      res = await fetch(url, { headers:{Authorization:`Bearer ${token}`}});
    } catch (e) {
      setStatus($("resultsStatus"), "network error", "err");
      alert(e?.message || String(e));
      return;
    }

    if (!res.ok) {
      setStatus($("resultsStatus"), `error ${res.status}`, "err");
      alert(await res.text());
      return;
    }

    const data = await res.json();
    setStatus($("resultsStatus"), `loaded ${data.count}`, "ok");

    // ---- Matched Groups
    $("groupsMeta").textContent = `${(data.count ?? 0)} groups`;

    const renderPerson = p => `
      <div style="margin-bottom:6px;">
        <span class="pill ${esc(p.gender)}">${esc(p.gender)}</span>
        <b>${esc(p.nickname)}</b>
        <span class="muted">(${esc(p.age)})</span>
        <div class="mini mono">${esc(p.user_id)} / ${esc(p.line_user_id || "")}</div>
      </div>
    `;

    $("resultsTbody").innerHTML = (data.groups || []).map(g => {
      const groupId = g.groupId;
      const token = g.token || "";
      const slotDt = g.slotDt || "";
      const location = g.location || "";
      const typeMode = g.typeMode || "";
      const status = g.status || "";

      const btnDisabled = token ? "" : "disabled";
      const btnTitle = token ? "運営メッセージ編集" : "tokenが無いので編集不可";

      return `
        <tr>
          <td class="mono">${esc(groupId)}</td>
          <td>${esc(fmtDateJa(slotDt))}</td>
          <td>${esc(location)}</td>
          <td>${esc(typeMode)}</td>
          <td>${esc(status)}</td>
          <td class="mono">${esc(token)}</td>
          <td>
            <button
              class="btn-ghost"
              ${btnDisabled}
              title="${esc(btnTitle)}"
              onclick="openOpsEditorFromRow('${esc(groupId)}','${esc(token)}','${esc(slotDt)}','${esc(location)}','${esc(typeMode)}','${esc(status)}')"
            >運営メッセージ</button>
            <div class="mini muted" style="margin-top:6px;">
              <a class="link" href="https://thematching-frontend.vercel.app/g/${encodeURIComponent(token)}" target="_blank" rel="noreferrer">公開ページ</a>
            </div>
          </td>
          <td>${(g.female || []).map(renderPerson).join("")}</td>
          <td>${(g.male || []).map(renderPerson).join("")}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="9" class="muted">no results</td></tr>`;

    // ---- Unmatched Users
    const unmatched = data.unmatchedUsers || [];
    const unmatchedCount = (data.unmatchedCount != null) ? data.unmatchedCount : unmatched.length;
    $("unmatchedMeta").textContent = `${unmatchedCount} users`;

    if (!unmatched.length) {
      $("unmatchedWrap").innerHTML = `<div class="muted">no unmatched users</div>`;
      return;
    }

    $("unmatchedWrap").innerHTML = unmatched.map(u => {
      const genderClass = (u.gender === "female" ? "female" : (u.gender === "male" ? "male" : ""));
      const age = (u.age === 0 || u.age === "0" || u.age == null) ? "—" : u.age;
      return `
        <div class="card" title="click to open user detail" data-user-id="${esc(u.user_id)}">
          <div class="row" style="margin:0; gap:8px;">
            <span class="pill ${genderClass}">${esc(u.gender || "-")}</span>
            <b>#${esc(u.user_id)}</b>
            <span class="muted">${esc(u.nickname || "(no nickname)")}</span>
            <span class="muted">age ${esc(age)}</span>
          </div>
          <div class="mini mono" style="margin-top:6px;">${esc(u.line_user_id || "")}</div>
        </div>
      `;
    }).join("");

    // unmatched card click -> drawer
    document.querySelectorAll('#unmatchedWrap [data-user-id]').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-user-id');
        if (id) loadUserDetail(id);
      });
    });
  };
</script>
</body>
</html>